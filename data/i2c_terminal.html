<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>I2C Terminal</title>
    <link rel="stylesheet" href="/css/pico.min.css">
</head>

<body>
    <header class="container">
        <h1>I2C Terminal</h1>
        <a role="button" href="/">Back</a>
    </header>
    <main class="container">
        <div class="grid">
            <article>
                <select name="Clock Frequency" id="speed_selector">
                    <option value="100000">100000 Hz</option>
                    <option value="400000">400000 Hz</option>
                </select>
                <fieldset role="group">
                    <input placeholder="Device address" list="devices" id="address_input">
                    <datalist id="devices">
                    </datalist>
                    <input type="button" value="Hex" />
                </fieldset>
                <button id="probe_btn">Probe</button>
                <button id="scan_btn">Scan</button>
            </article>
            <article>
                <fieldset role="group">
                    <input placeholder="Register address" id="register_input_read">
                    <input type="button" value="Hex" />
                </fieldset>
                <fieldset role="group">
                    <input placeholder="Byte number" id="number_input">
                    <input type="button" value="Dec" />
                </fieldset>
                <button id="read_btn">Read</button>
            </article>
            <article>
                <fieldset role="group">
                    <input placeholder="Register address (optional)" id="register_input_write">
                    <input type="button" value="Hex" />
                </fieldset>
                <fieldset role="group">
                    <input placeholder="Value as hex number(s)" id="write_input">
                    <input type="button" value="[Hex]" />
                </fieldset>
                <button id="write_btn">Write</button>
            </article>
        </div>
    </main>
    <footer class="container">
        <h3>Console</h3>
        <textarea id="output" name="read-only" readonly style="min-height: 500px;"></textarea>
    </footer>
    <script src="/js/protobuf.min.js"></script>
    <script src="/js/lib/i2c_addr_db.js"></script>
    <script src="/js/lib/utils.js"></script>
    <script src="/js/lib/pb.js"></script>
    <script src="/js/lib/i2c.js"></script>
    <script>
        let bus;
        window.addEventListener('load', async (event) => {
            bus = await openI2CPromisified();
            console.log('The page has fully loaded');
        });

        document.getElementById("scan_btn").onclick = async () => {
            let speed = getInputNumber("speed_selector");
            printText(`Scanning started on frequency ${speed} Hz...\r\n`);
            document.getElementById("devices").innerHTML = "";
            bus.scan()
                .then((devices) => {
                    if (devices.length === 0) {
                        printText("No devices found\r\n");
                    }
                    else {
                        for (let i = 0; i < devices.length; i++) {
                            printText(`Found device on ${stringToHex(devices[i])}\r\n`);
                            elementTextAppend("devices", `<option value=\"${stringToHex(devices[i])}\">`);
                            if (devices[i] in db && db[devices[i]].length > 0) {
                                printText(`Probably this device is one from following list: ${db[devices[i]]}\r\n`);
                            }
                        }
                    }
                    printText("Finish!\r\n");
                })
                .catch((err) => {
                    console.log(err);
                    printText("Network error!\r\n");
                });
        };
        document.getElementById("probe_btn").onclick = async () => {
            let address = getInputInt16Value("address_input");
            if (!validateNumber(address, 0, 127)) {
                printText("Please enter correct device address\r\n");
                return;
            }
            let speed = getInputNumber("speed_selector");
            bus.probe(address, speed)
                .then((response) => { printText(response ? "Address exists\r\n" : "No device\r\n"); })
                .catch(() => { printText("Network error!\r\n") });
        }

        document.getElementById("read_btn").onclick = async () => {
            let address = getInputInt16Value("address_input");
            let register = getInputInt16ArrayValue("register_input_read");
            let byte_quantity = getInputNumber("number_input");
            let speed = getInputNumber("speed_selector");
            if (!validateNumber(address, 0, 127)) {
                printText("Please enter correct device address\r\n");
                return;
            }
            if (!validateBytearray(register)) {
                printText("Please enter correct register number\r\n");
                return;
            }
            if (!validateNumber(byte_quantity, 0, 255)) {
                printText("Please enter correct number of bytes to read\r\n");
                return;
            }
            printText(`Requested ${byte_quantity} bytes on ${speed} Hz from ${register.map((byte) => stringToHex(byte))} register of ${stringToHex(address)} device\r\n`);

            bus.i2cReadReg(address, register, byte_quantity, speed)
                .then((response) => {
                    if (getI2CErrorText(response.error)) {
                        printText(`${getI2CErrorText(response.error)}\r\n`)
                    }
                    else {
                        if (response.read.length < byte_quantity) {
                            printText(`Got less bytes from device than expected; probably answer from device is not correct; here are bytes from device: ${(response.read).map((byte) => stringToHex(byte))}\r\n`);
                        }
                        else {
                            printText(`Got following bytes from device: ${(response.read).map((byte) => stringToHex(byte))}\r\n`);
                        }
                    }
                })
                .catch((err) => {
                    console.log(err);
                    printText("Network error!\r\n");
                });
        }
        document.getElementById("write_btn").onclick = async () => {
            let address = getInputInt16Value("address_input");
            let bytes = getInputInt16ArrayValue("write_input");
            let register = getInputInt16Value("register_input_write");
            let speed = getInputNumber("speed_selector");
            if (!validateNumber(address, 0, 127)) {
                printText("Please enter correct device address\r\n");
                return;
            }
            if (!validateBytearray(bytes)) {
                printText("Please enter correct data to write\r\n");
                return;
            }
            if (!validateNumber(register, 0, 255)) {
                printText("Please enter correct register address or no address\r\n");
                return;
            }
            printText(`Written ${bytes.map((byte) => stringToHex(byte))} on ${stringToHex(address)} device on ${speed} Hz\r\n`);
            bus.i2cWriteReg(address, register, bytes, speed)
                .then((result) => {
                    console.log(result);
                    if (getI2CErrorText(result.error)) {
                        printText(`${getI2CErrorText(result.error)}\r\n`)
                    }
                })
                .catch((err) => {
                    console.log(err);
                    printText("Network error!\r\n")
                });
        }
    </script>
</body>

</html>