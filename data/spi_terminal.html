<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SPI Terminal</title>
    <link rel="stylesheet" href="/css/pico.min.css">
</head>

<body>
    <header class="container">
        <h1>SPI Terminal</h1>
        <a role="button" href="/">Back</a>
    </header>
    <main class="container">
        <div class="grid">
            <article>
                <fieldset role="group">
                    <input placeholder="Frequency" id="spi_frequency_input"
                        value="2000000">
                    <input type="button" value="Dec" />
                </fieldset>
                <select name="Bit order" id="spi_order_input">
                    <option value="0">LSB</option>
                    <option value="1" selected>MSB</option>
                </select>
                <select name="Mode" id="spi_mode_input">
                    <option value="0" selected>SPI Mode 0</option>
                    <option value="1">SPI Mode 1</option>
                    <option value="2">SPI Mode 2</option>
                    <option value="3">SPI Mode 3</option>
                </select>
            </article>
            <article>
                <fieldset role="group">
                    <input placeholder="Value as hex number(s)" id="write_input">
                    <input type="button" value="[Hex]" />
                </fieldset>
                <button id="write_btn">Write</button>
            </article>
            <article>
                <fieldset role="group">
                    <input placeholder="Value as hex number(s)" id="write_read_input">
                    <input type="button" value="[Hex]" />
                </fieldset>
                <fieldset role="group">
                    <input placeholder="Number of bytes" id="bytes_number_input">
                    <input type="button" value="Dec" />
                </fieldset>
                <fieldset role="group">
                    <input placeholder="Placeholder byte" id="bytes_number_input">
                    <input type="button" value="Dec" />
                </fieldset>
                <button id="write_read_btn">Write&Read</button>
            </article>
        </div>
    </main>
    <footer class="container">
        <h3>Console</h3>
        <textarea id="output" name="read-only" readonly style="min-height: 500px;"></textarea>
    </footer>
    <script src="/js/protobuf.min.js"></script>
    <script src="/js/lib/utils.js"></script>
    <script src="/js/lib/pb.js"></script>
    <script src="/js/lib/ws.js"></script>
    <script src="/js/lib/spi.js"></script>
    <script>
        window.addEventListener('load', onload);
        let firstConnection = true;

        function onload(event) {
            initSPI(() => {
                if (firstConnection) {
                    firstConnection = false;
                    printText("Connected to device\r\n");
                }
                else {
                    printText("Reconnected to device\r\n");
                }
            });
        }

        document.getElementById("write_btn").onclick = async () => {
            let bytes = getInputInt16ArrayValue("write_input");
            let frequency = parseInt(getInputValue("spi_frequency_input"));
            let order = parseInt(getInputValue("spi_order_input"));
            let mode = parseInt(getInputValue("spi_mode_input"));
            if (!validateBytearray(bytes)) {
                printText("Please enter correct data to write\r\n");
                return;
            }
            printText("Sent byte(s):\r\n");
            printText(`${bytes.map((byte) => stringToHex(byte))}\r\n`);
            writeSPI(bytes, frequency, order, mode)
                .then((error) => {
                    if (getSPIErrorText(error)) {
                        printText(`${getSPIErrorText(error)}\r\n`)
                    }
                })
                .catch(() => { printText("Network error\r\n") });
        }

        document.getElementById("write_read_btn").onclick = async () => {
            let bytes = getInputInt16ArrayValue("write_read_input");
            let byte_quantity = parseInt(getInputValue("bytes_number_input"));
            let placeholder_byte = getInputInt16Value("placeholder_byte_input");
            let frequency = parseInt(getInputValue("spi_frequency_input"));
            let order = parseInt(getInputValue("spi_order_input"));
            let mode = parseInt(getInputValue("spi_mode_input"));
            if (!validateNumber(frequency, 100000, 25000000)) {
                printText("Please enter correct frequency\r\n");
                return;
            }
            if (!validateBytearray(bytes)) {
                printText("Please enter correct data to write\r\n");
                return;
            }
            if (!validateNumber(byte_quantity, 0, 1023)) {
                printText("Please enter correct byte quantity\r\n");
                return;
            }
            if (!validateNumber(placeholder_byte, 0, 255)) {
                printText("Please enter correct placeholder byte\r\n");
                return;
            }
            printText("Sent byte(s):\r\n");
            printText(`${bytes.map((byte) => stringToHex(byte))}\r\n`);
            writeReadSPI(bytes, byte_quantity, placeholder_byte, frequency, order, mode)
                .then((response) => {
                    if (getSPIErrorText(response.error)) {
                        printText(`${getSPIErrorText(response.error)}\r\n`)
                    }
                    else {
                        printText(`Read following ${byte_quantity} bytes using placeholder ${placeholder_byte}\r\n`);
                        printText(`${response.read}\r\n`);
                    }
                })
                .catch(() => { printText("Network error\r\n") });
        }
    </script>
</body>

</html>